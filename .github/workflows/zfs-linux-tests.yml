name: zfs-linux-tests

on:
  workflow_call:
    inputs:
      os:
        description: 'The ubuntu version: 22.04'
        required: true
        type: string

jobs:

  zloop:
    runs-on: ubuntu-${{ inputs.os }}
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}
    - uses: actions/download-artifact@v4
      with:
        name: modules-${{ inputs.os }}
    - name: Install modules
      run: |
        tar xzf modules-${{ inputs.os }}.tgz
        .github/workflows/scripts/setup-dependencies.sh tests
    - name: Tests
      timeout-minutes: 30
      run: |
        sudo mkdir -p /var/tmp/zloop
        # run for 10 minutes or at most 2 iterations for a maximum runner
        #   time of 20 minutes.
        sudo /usr/share/zfs/zloop.sh -t 600 -I 2 -l -m1 -- -T 120 -P 60
    - name: Prepare artifacts
      if: failure()
      run: |
        sudo chmod +r -R /var/tmp/zloop/
    - uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: Zloop-logs-${{ inputs.os }}
        path: |
          /var/tmp/zloop/*/
          !/var/tmp/zloop/*/vdev/
        retention-days: 14
        if-no-files-found: ignore
    - uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: Zloop-files-${{ inputs.os }}
        path: |
          /var/tmp/zloop/*/vdev/
        retention-days: 14
        if-no-files-found: ignore
