#!/bin/sh

ZPOOL_FORCE=""
for p in $(getargs rd.zpool.force=) ; do
	if [ "$p" = "1" ] ; then
		ZPOOL_FORCE="-f"
	else
		ZPOOL_FORCE=""
	fi
done

if [ "${ZFSROOT}" = "true" ] ; then
	udevsettle
	if [ $SEEK_BOOTFS -eq 1 ] ; then
		bootfs=`zpool list -H -o bootfs | sed -n '/-/ !p' | sed 'q'`
		if [ "$?" != "0" ] || [ "$bootfs" = "no pools available" ] || [ -z "$bootfs" ] ; then
			info "ZFS: Failed to get bootfs, trying more thoroughly"
			zpool import -N -a "${ZPOOL_FORCE}"
			bootfs=`zpool list -H -o bootfs | sed -n '/-/ !p' | sed 'q'`
			if [ "$?" != "0" ] || [ "$bootfs" = "" ] || [ $bootfs = "no pools available" ] ; then
				rootok=0
				die "ZFS: Failed to find bootfs, consider specifying it manually"
				zpool list -H -o name | while read exppool ; do
					zpool export "$exppool"
				done
			fi
		fi
	else
		pool="${root%%/*}"
		bootfs="${root}"
		info "ZFS: pool = $pool"
		info "ZFS: bootfs = $bootfs"
		if ! zpool import -N "$ZPOOL_FORCE" "$pool" ; then
			warn "ZFS: unable to import pool $pool"
			rootok=0
		fi
	fi

	mp=`zfs get -H -o value mountpoint $bootfs`
	info "ZFS: mp = $mp"
	info "ZFS: bootfs = $bootfs"
	if [ "$mp" = "legacy" ] ; then
		mount -o rw -t zfs "$bootfs" "$NEWROOT" && ROOT_MOUNTED=yes
	else
		mount -o rw,zfsutil -t zfs "$bootfs" "$NEWROOT" && ROOT_MOUNTED=yes
	fi
	if [ "$?" != "0" ] ; then
		warn "ZFS: something went wrong while mounting root filesystem"
	fi
else
	info "zfs not used"
fi
